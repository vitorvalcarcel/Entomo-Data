<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('EntomoData - In√≠cio')}"></head>
<body>

    <script>
        let delayTimer;

        function filtrar(pagina) {
            clearTimeout(delayTimer);
            delayTimer = setTimeout(function() {
                enviarRequisicao(pagina);
            }, 300);
        }

        // Fun√ß√£o corrigida para ler do atributo data-field
        function ordenar(elemento) {
            let campo = elemento.getAttribute('data-field');
            let currentField = document.getElementById('sortField').value;
            let currentDir = document.getElementById('sortDir').value;
            
            let newDir = 'asc';
            if (campo === currentField) {
                newDir = (currentDir === 'asc') ? 'desc' : 'asc';
            }
            
            document.getElementById('sortField').value = campo;
            document.getElementById('sortDir').value = newDir;
            
            filtrar(0);
        }

        function enviarRequisicao(pagina) {
            let size = document.getElementById('sizeSelect').value;
            let sort = document.getElementById('sortField').value;
            let dir = document.getElementById('sortDir').value;
            
            let inputs = document.querySelectorAll('#painelFiltros .filtro-input');
            let params = new URLSearchParams();
            params.append('page', pagina);
            params.append('size', size);
            params.append('sort', sort);
            params.append('dir', dir);

            for (let input of inputs) {
                if (input.value) {
                    params.append(input.name, input.value);
                }
            }

            fetch('/filtrar?' + params.toString())
                .then(response => response.text())
                .then(html => {
                    let areaTabela = document.getElementById('area-tabela');
                    if (areaTabela) {
                        areaTabela.outerHTML = html;
                        sincronizarRolagem();
                    }
                });
        }
        
        function mudarTamanho() {
            filtrar(0);
        }

        function toggleFiltros() {
            let painel = document.getElementById('painelFiltros');
            let btn = document.getElementById('btnFiltros');
            if (painel.style.display === 'none' || painel.style.display === '') {
                painel.style.display = 'block';
                btn.classList.add('ativo');
                btn.innerHTML = '<span>‚ñº</span> Ocultar Filtros';
            } else {
                painel.style.display = 'none';
                btn.classList.remove('ativo');
                btn.innerHTML = '<span>üîç</span> Filtrar Dados';
            }
        }

        function toggleInput(checkbox) {
            let container = checkbox.closest('.item-filtro');
            let input = container.querySelector('.filtro-input');
            if (checkbox.checked) {
                input.style.display = 'block';
                input.focus();
            } else {
                input.style.display = 'none';
                input.value = '';
                filtrar(0);
            }
        }

        function sincronizarRolagem() {
            let topo = document.getElementById('scrollTopWrapper');
            let conteudoTopo = document.getElementById('scrollTopContent');
            let tabelaContainer = document.querySelector('.tabela-container');
            let tabela = document.querySelector('table');

            if (!topo || !tabelaContainer || !tabela) return;
            conteudoTopo.style.width = tabela.offsetWidth + 'px';
            topo.onscroll = function() { tabelaContainer.scrollLeft = topo.scrollLeft; };
            tabelaContainer.onscroll = function() { topo.scrollLeft = tabelaContainer.scrollLeft; };
        }

        function abrirModalExclusao(cod) {
            let modal = document.getElementById('modalExclusaoIndividual');
            let spanCod = document.getElementById('codExclusao');
            let btnConfirmar = document.getElementById('btnConfirmarExclusao');
            
            spanCod.innerText = cod;
            btnConfirmar.href = "/deletar/" + cod;
            
            modal.classList.add('ativo');
        }

        function fecharModalExclusao() {
            document.getElementById('modalExclusaoIndividual').classList.remove('ativo');
        }

        window.onload = function() {
            sincronizarRolagem();
            let inputs = document.querySelectorAll('.filtro-input');
            inputs.forEach(input => {
                if (input.value.trim() !== '') {
                    input.style.display = 'block';
                    let checkbox = input.parentElement.querySelector('input[type="checkbox"]');
                    if(checkbox) checkbox.checked = true;
                    document.getElementById('painelFiltros').style.display = 'block';
                    document.getElementById('btnFiltros').classList.add('ativo');
                }
            });
        };
    </script>

    <div class="header-container">
        <h1>üêù EntomoData <span style="font-weight: normal; font-size: 0.8em; color: #7f8c8d;">| Gerenciamento</span></h1>
        <div>
            <span style="font-size: 14px; color: #666; margin-right: 10px;">Exibir:</span>
            <select id="sizeSelect" onchange="mudarTamanho()" class="seletor-pagina">
                <option value="50" th:selected="${pageSize == 50}">50 itens</option>
                <option value="100" th:selected="${pageSize == 100}">100 itens</option>
                <option value="1000" th:selected="${pageSize == 1000}">1000 itens</option>
                <option value="10000" th:selected="${pageSize == 10000}">10000 itens</option>
            </select>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="/novo" style="text-decoration: none;"><button class="btn btn-novo" style="margin-right: 10px;">+ Novo Exemplar</button></a>
        <a href="/importar" style="text-decoration: none;"><button class="btn btn-importar" style="margin-right: 10px;">üìÇ Importar Excel</button></a>
        <a href="/deletar" style="text-decoration: none;"><button class="btn btn-salvar" style="background-color: #e74c3c; box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);">üóëÔ∏è Apagar em Massa</button></a>
    </div>

    <button id="btnFiltros" onclick="toggleFiltros()" class="btn btn-filtro"><span>üîç</span> Filtrar Dados</button>

    <div id="painelFiltros" class="painel-filtros">
        <div class="grid-filtros">
            <div th:each="campo : ${camposHelper.todosCampos}" class="item-filtro">
                <label class="toggle-filtro">
                    <input type="checkbox" onchange="toggleInput(this)"> 
                    <span th:text="${campo.value}">Nome</span>
                </label>
                <input th:name="${campo.key}" 
                       th:value="${filtro.__${campo.key}__}" 
                       class="filtro-input" 
                       onkeyup="filtrar(0)">
            </div>
        </div>
    </div>

    <div id="area-tabela" th:fragment="tabela-resultados" class="card-tabela">
        <input type="hidden" id="sortField" th:value="${sortField}">
        <input type="hidden" id="sortDir" th:value="${sortDir}">

        <div style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: flex-end;">
            <span class="total-badge">Total: <span th:text="${totalItems}">0</span></span>
        </div>

        <div id="scrollTopWrapper" class="scroll-topo-wrapper">
            <div id="scrollTopContent" class="scroll-topo-content"></div>
        </div>

        <div class="tabela-container">
            <table class="tabela-larga">
                <thead>
                    <tr>
                        <th style="width: 80px; text-align: center;">A√ß√µes</th>
                        
                        <th th:each="campo : ${camposHelper.todosCampos}" 
                            th:data-field="${campo.key}"
                            onclick="ordenar(this)" 
                            class="sortable">
                            <span th:text="${campo.value}">Nome</span>
                            <span th:if="${sortField == campo.key}" th:text="${sortDir == 'asc' ? '‚ñ≤' : '‚ñº'}"></span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="abelha : ${listaDeAbelhas.content}">
                        <td style="white-space: nowrap; text-align: center;">
                            <a th:href="@{/editar/{cod}(cod=${abelha.cod})}" title="Editar" class="btn-acao btn-editar">‚úèÔ∏è</a>
                            
                            <button type="button" 
                                    th:data-cod="${abelha.cod}"
                                    onclick="abrirModalExclusao(this.getAttribute('data-cod'))"
                                    title="Apagar" 
                                    class="btn-acao btn-excluir" 
                                    style="border:none; cursor:pointer;">üóëÔ∏è</button>
                        </td>
                        
                        <td th:each="campo : ${camposHelper.todosCampos}" 
                            th:text="${abelha.__${campo.key}__}">
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="padding: 20px; text-align: center; background-color: #fcfcfc; border-top: 1px solid #f1f1f1;" th:if="${totalPages > 1}">
            
            <button th:if="${currentPage > 0}" 
               th:data-page="${currentPage - 1}"
               onclick="filtrar(this.getAttribute('data-page'))"
               class="btn btn-paginacao">&laquo; Anterior</button>
            
            <span style="margin: 0 15px; font-weight: 600; color: #555;">
                P√°gina <span th:text="${currentPage + 1}">1</span> de <span th:text="${totalPages}">10</span>
            </span>

            <button th:if="${currentPage < totalPages - 1}" 
               th:data-page="${currentPage + 1}"
               onclick="filtrar(this.getAttribute('data-page'))"
               class="btn btn-paginacao">Pr√≥ximo &raquo;</button>
        </div>
    </div>

    <div id="modalExclusaoIndividual" class="modal-overlay" onclick="if(event.target === this) fecharModalExclusao()">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background-color: #fdedec; border-bottom: 1px solid #fadbd8;">
                <h3 style="color: #c0392b;">‚ö†Ô∏è Confirmar Exclus√£o</h3>
                <button type="button" class="btn-fechar" onclick="fecharModalExclusao()">√ó</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <p style="font-size: 16px; color: #555; margin-bottom: 20px;">
                    Tem certeza que deseja apagar o exemplar <strong id="codExclusao" style="color: #c0392b; font-size: 1.2em;"></strong>?
                </p>
                <p style="font-size: 13px; color: #999;">Esta a√ß√£o n√£o pode ser desfeita.</p>
                <div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px;">
                    <button onclick="fecharModalExclusao()" class="btn btn-paginacao">Cancelar</button>
                    <a id="btnConfirmarExclusao" href="#" class="btn btn-salvar" style="background-color: #c0392b;">Sim, Apagar</a>
                </div>
            </div>
        </div>
    </div>

</body>
</html>